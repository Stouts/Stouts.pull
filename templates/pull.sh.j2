#!/bin/bash

# This file was generated by Ansible for {{ansible_fqdn}}
# Do NOT modify this file by hand!

LOGFILE="{{pull_logs_directory}}/pull.log"
touch $LOGFILE

export PATH=$PATH:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

echo
echo "PULL: [ansible-pull] run $(date)" >> $LOGFILE

ps -ef | grep ansible-pull | grep -v grep && echo "PULL: [ansible-pull] Already running - EXIT" >> $LOGFILE && exit 1

ansible-pull -d {{pull_work_directory}} -U {{pull_repo_url}} -C {{pull_repo_version}} {{"-o" if pull_only_if_changed else ""}} {{ ("-i " + pull_work_directory + "/" + pull_inventory) if pull_inventory else ""}} -e "@{{pull_base_directory}}/pull.json" -{{pull_verbose}} {{pull_playbook}}>> $LOGFILE 2>&1

[ -d {{pull_work_directory}}/.git ] && cd {{pull_work_directory}} && git submodule update --init >> $LOGFILE 2>&1

exit $?
